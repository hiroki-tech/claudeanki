<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Ankié€ä¿¡ãƒ„ãƒ¼ãƒ«</title>
<style>
  * { box-sizing: border-box; margin: 0; padding: 0; }
  body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif; background: #f3f4f6; min-height: 100vh; padding: 24px; }
  .container { max-width: 760px; margin: 0 auto; }
  h1 { font-size: 1.5rem; font-weight: 700; color: #1f2937; margin-bottom: 4px; }
  .subtitle { font-size: 0.875rem; color: #6b7280; margin-bottom: 24px; }
  .section { background: white; border-radius: 12px; padding: 20px; margin-bottom: 16px; border: 1px solid #e5e7eb; }
  .section-title { font-size: 0.875rem; font-weight: 600; color: #374151; margin-bottom: 12px; }
  textarea {
    width: 100%; height: 120px; border: 1px solid #d1d5db; border-radius: 8px;
    padding: 10px 12px; font-size: 0.8rem; font-family: monospace; resize: vertical;
    outline: none; transition: border-color 0.2s;
  }
  textarea:focus { border-color: #3b82f6; box-shadow: 0 0 0 2px rgba(59,130,246,0.2); }
  .load-btn {
    margin-top: 10px; padding: 8px 20px; background: #3b82f6; color: white;
    border: none; border-radius: 8px; font-size: 0.875rem; font-weight: 600;
    cursor: pointer; transition: background 0.2s;
  }
  .load-btn:hover { background: #2563eb; }
  .deck-row { display: flex; align-items: center; gap: 12px; margin-bottom: 16px; }
  .deck-row label { font-size: 0.875rem; font-weight: 500; color: #374151; white-space: nowrap; }
  .deck-row input {
    flex: 1; border: 1px solid #d1d5db; border-radius: 8px; padding: 8px 12px;
    font-size: 0.875rem; outline: none; transition: border-color 0.2s;
  }
  .deck-row input:focus { border-color: #3b82f6; }
  .controls { display: flex; gap: 10px; align-items: center; margin-bottom: 14px; flex-wrap: wrap; }
  .ctrl-btn {
    font-size: 0.8rem; padding: 6px 14px; border-radius: 8px; border: none;
    cursor: pointer; font-weight: 500; transition: background 0.2s;
  }
  .ctrl-btn.all { background: #dbeafe; color: #1d4ed8; }
  .ctrl-btn.all:hover { background: #bfdbfe; }
  .ctrl-btn.none { background: #e5e7eb; color: #4b5563; }
  .ctrl-btn.none:hover { background: #d1d5db; }
  .count { margin-left: auto; font-size: 0.8rem; color: #9ca3af; }

  /* ã‚«ãƒ¼ãƒ‰ãƒªã‚¹ãƒˆ */
  .card-list { display: flex; flex-direction: column; gap: 8px; margin-bottom: 16px; }
  .card-item {
    border: 1px solid #e5e7eb; border-radius: 12px; padding: 14px 16px;
    transition: all 0.15s; background: #f9fafb;
  }
  .card-item.checked { border-color: #60a5fa; background: white; box-shadow: 0 1px 4px rgba(0,0,0,0.06); }
  .card-item.review-marked { border-color: #f59e0b !important; background: #fffbeb !important; box-shadow: 0 1px 4px rgba(245,158,11,0.15) !important; opacity: 1 !important; }

  .card-row { display: flex; gap: 12px; align-items: flex-start; }
  .checkbox {
    width: 20px; height: 20px; border-radius: 4px; border: 2px solid #d1d5db;
    flex-shrink: 0; margin-top: 2px; display: flex; align-items: center; justify-content: center;
    transition: all 0.15s; background: white; cursor: pointer;
  }
  .card-item.checked .checkbox { background: #3b82f6; border-color: #3b82f6; }
  .checkmark { display: none; }
  .card-item.checked .checkmark { display: block; }

  .card-content { flex: 1; min-width: 0; }
  .card-meta { display: flex; align-items: center; gap: 8px; margin-bottom: 4px; }
  .qnum { font-size: 0.7rem; font-weight: 700; color: #2563eb; background: #eff6ff; padding: 2px 8px; border-radius: 4px; }
  .qtag { font-size: 0.7rem; color: #9ca3af; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
  .qfront { font-size: 0.875rem; font-weight: 500; color: #1f2937; margin-bottom: 2px; }
  .qback { font-size: 0.8rem; color: #6b7280; margin-bottom: 2px; }
  .qextra { font-size: 0.75rem; color: #9ca3af; background: #f9fafb; border-radius: 6px; padding: 6px 8px; margin-top: 4px; border-left: 2px solid #e5e7eb; }
  .qextra a { color: #3b82f6; }
  .deck-row select {
    flex: 1; border: 1px solid #d1d5db; border-radius: 8px; padding: 8px 12px;
    font-size: 0.875rem; outline: none; transition: border-color 0.2s; background: white;
  }
  .deck-row select:focus { border-color: #3b82f6; }
  .fetch-deck-btn {
    padding: 8px 14px; background: #f3f4f6; color: #374151; border: 1px solid #d1d5db;
    border-radius: 8px; font-size: 0.8rem; font-weight: 500; cursor: pointer; white-space: nowrap;
    transition: background 0.2s;
  }
  .fetch-deck-btn:hover { background: #e5e7eb; }

  /* ä¿®æ­£ãƒœã‚¿ãƒ³ */
  .card-actions { display: flex; justify-content: flex-end; margin-top: 10px; }
  .review-btn {
    font-size: 0.75rem; padding: 4px 12px; border-radius: 6px; border: 1px solid #f59e0b;
    background: white; color: #d97706; cursor: pointer; font-weight: 500;
    transition: all 0.15s; display: flex; align-items: center; gap: 4px;
  }
  .review-btn:hover { background: #fef3c7; }
  .review-btn.active { background: #f59e0b; color: white; border-color: #f59e0b; }

  /* ä¿®æ­£ç†ç”±ãƒ‘ãƒãƒ« */
  .review-panel {
    display: none; margin-top: 10px; padding: 12px; background: #fffbeb;
    border-radius: 8px; border: 1px solid #fde68a;
  }
  .review-panel.open { display: block; }
  .review-panel select, .review-panel input {
    width: 100%; padding: 7px 10px; border: 1px solid #fcd34d; border-radius: 6px;
    font-size: 0.8rem; outline: none; background: white; margin-bottom: 8px;
  }
  .review-panel select:focus, .review-panel input:focus { border-color: #f59e0b; }
  .review-panel-label { font-size: 0.75rem; font-weight: 600; color: #92400e; margin-bottom: 6px; }
  .custom-input { display: none; }
  .custom-input.show { display: block; }

  /* ä¿®æ­£ä¾é ¼ã¾ã¨ã‚ã‚»ã‚¯ã‚·ãƒ§ãƒ³ */
  .review-summary { background: #fffbeb; border: 1px solid #fde68a; border-radius: 12px; padding: 20px; margin-bottom: 16px; display: none; }
  .review-summary.show { display: block; }
  .review-summary-title { font-size: 0.875rem; font-weight: 600; color: #92400e; margin-bottom: 12px; display: flex; align-items: center; gap: 8px; }
  .review-count-badge { background: #f59e0b; color: white; font-size: 0.7rem; font-weight: 700; padding: 2px 8px; border-radius: 10px; }
  .copy-review-btn {
    width: 100%; padding: 10px; border-radius: 8px; font-size: 0.875rem; font-weight: 700;
    color: white; border: none; cursor: pointer; background: #d97706; transition: background 0.2s;
  }
  .copy-review-btn:hover { background: #b45309; }
  .copy-review-btn.copied { background: #059669; }

  /* é€ä¿¡ãƒœã‚¿ãƒ³ */
  .send-btn {
    width: 100%; padding: 14px; border-radius: 12px; font-size: 1rem; font-weight: 700;
    color: white; border: none; cursor: pointer; transition: background 0.2s; background: #2563eb;
  }
  .send-btn:hover { background: #1d4ed8; }
  .send-btn:disabled { background: #d1d5db; cursor: not-allowed; }
  .status { margin-top: 12px; padding: 12px 16px; border-radius: 10px; font-size: 0.875rem; font-weight: 500; text-align: center; }
  .status.success { background: #f0fdf4; border: 1px solid #86efac; color: #15803d; }
  .status.error { background: #fef2f2; border: 1px solid #fca5a5; color: #dc2626; }
  .status.loading { background: #eff6ff; border: 1px solid #93c5fd; color: #1d4ed8; }
  .empty { text-align: center; color: #9ca3af; font-size: 0.875rem; padding: 32px; }
  .json-example { font-size: 0.75rem; color: #6b7280; margin-top: 8px; background: #f9fafb; border-radius: 6px; padding: 8px 10px; font-family: monospace; }

  /* ãƒ˜ãƒ«ãƒ—ã‚»ã‚¯ã‚·ãƒ§ãƒ³ */
  .help-toggle {
    display: flex; align-items: center; gap: 6px; font-size: 0.8rem; font-weight: 600;
    color: #6b7280; cursor: pointer; user-select: none; margin-bottom: 0;
    background: none; border: none; padding: 0;
  }
  .help-toggle:hover { color: #374151; }
  .help-toggle .arrow { transition: transform 0.2s; display: inline-block; }
  .help-toggle.open .arrow { transform: rotate(90deg); }
  .help-body { display: none; margin-top: 14px; }
  .help-body.open { display: block; }
  .help-step { display: flex; gap: 12px; margin-bottom: 14px; align-items: flex-start; }
  .help-step-num {
    width: 22px; height: 22px; border-radius: 50%; background: #3b82f6; color: white;
    font-size: 0.7rem; font-weight: 700; display: flex; align-items: center; justify-content: center;
    flex-shrink: 0; margin-top: 1px;
  }
  .help-step-text { font-size: 0.8rem; color: #374151; line-height: 1.6; }
  .help-step-text strong { color: #1f2937; }
  .help-code {
    background: #1e293b; color: #e2e8f0; border-radius: 8px; padding: 12px 14px;
    font-family: monospace; font-size: 0.75rem; line-height: 1.7; margin-top: 8px;
    overflow-x: auto; white-space: pre;
  }
  .help-code .key { color: #93c5fd; }
  .help-code .val { color: #86efac; }
  .help-code .comment { color: #94a3b8; }
  .help-fields { margin-top: 10px; display: flex; flex-direction: column; gap: 6px; }
  .help-field { display: flex; gap: 8px; font-size: 0.78rem; }
  .help-field-key { font-weight: 700; color: #2563eb; min-width: 60px; font-family: monospace; }
  .help-field-desc { color: #4b5563; }
  .help-field-req { font-size: 0.65rem; color: #dc2626; font-weight: 600; margin-left: 4px; }
  .help-field-opt { font-size: 0.65rem; color: #9ca3af; font-weight: 600; margin-left: 4px; }
  .help-divider { border: none; border-top: 1px solid #e5e7eb; margin: 14px 0; }
</style>
</head>
<body>
<div class="container">
  <h1>ğŸ“š Ankié€ä¿¡ãƒ„ãƒ¼ãƒ«</h1>
  <p class="subtitle">JSONã‚’è²¼ã‚Šä»˜ã‘ã¦å•é¡Œã‚’é¸æŠã—ã€Ankiã«ç›´æ¥é€ä¿¡</p>

  <!-- ãƒ˜ãƒ«ãƒ— -->
  <div class="section">
    <button class="help-toggle" id="helpToggle" onclick="toggleHelp()">
      <span class="arrow">â–¶</span> ä½¿ã„æ–¹ãƒ»JSONã®ä½œã‚Šæ–¹
    </button>
    <div class="help-body" id="helpBody">
      <div class="help-step"><div class="help-step-num">1</div><div class="help-step-text"><strong>PDFã‚’Claudeã«é€ä¿¡</strong><br>PDFã‚’Claude.aiã«ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã—ã€Œå…¨ã‚»ã‚¯ã‚·ãƒ§ãƒ³ç¶²ç¾…ã—ã¦å•é¡Œã‚’ä½œã£ã¦ã€‚ã‚¿ã‚°ã¯XXã€ãƒªãƒ³ã‚¯ã¯XXã€ã¨æŒ‡ç¤ºã™ã‚‹ã€‚</div></div>
      <div class="help-step"><div class="help-step-num">2</div><div class="help-step-text"><strong>ClaudeãŒJSONã‚’å‡ºåŠ›</strong><br>ä»¥ä¸‹ã®å½¢å¼ã®JSONãŒå‡ºåŠ›ã•ã‚Œã‚‹ã€‚ã‚³ãƒ”ãƒ¼ã—ã¦ä¸‹ã®å…¥åŠ›æ¬„ã«è²¼ã‚Šä»˜ã‘ã‚‹ã€‚<div class="help-code">[
  {
    "front": "è³ªå•æ–‡",
    "back":  "ç­”ãˆ",
    "extra": "è£œè¶³ãƒ»è§£èª¬ï¼ˆçœç•¥å¯ï¼‰",
    "tag":   "ç”»åƒè¨ºæ–­::2023::07::ã‚¿ã‚¤ãƒˆãƒ«"
  }
]</div><div class="help-fields"><div class="help-field"><span class="help-field-key">front</span><span class="help-field-req">å¿…é ˆ</span><span class="help-field-desc">ã‚«ãƒ¼ãƒ‰è¡¨é¢ã®è³ªå•æ–‡</span></div><div class="help-field"><span class="help-field-key">back</span><span class="help-field-req">å¿…é ˆ</span><span class="help-field-desc">ã‚«ãƒ¼ãƒ‰è£é¢ã®ç­”ãˆ</span></div><div class="help-field"><span class="help-field-key">extra</span><span class="help-field-opt">ä»»æ„</span><span class="help-field-desc">è£é¢ä¸‹éƒ¨ã«è¡¨ç¤ºã•ã‚Œã‚‹è£œè¶³ãƒ»ã‚½ãƒ¼ã‚¹ãƒªãƒ³ã‚¯</span></div><div class="help-field"><span class="help-field-key">tag</span><span class="help-field-opt">ä»»æ„</span><span class="help-field-desc">Ankiã®ã‚¿ã‚°ã€‚::ã§éšå±¤åŒ–ã§ãã‚‹</span></div></div></div></div>
      <div class="help-step"><div class="help-step-num">3</div><div class="help-step-text"><strong>å•é¡Œã‚’é¸æŠã—ã¦Ankiã«é€ä¿¡</strong><br>ãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹ã§é€ä¿¡ã™ã‚‹å•é¡Œã‚’é¸ã³ã€ŒAnkiã«é€ä¿¡ã€ãƒœã‚¿ãƒ³ã‚’æŠ¼ã™ã€‚<strong>âœï¸ ä¿®æ­£ã‚’ä¾é ¼</strong>ãƒœã‚¿ãƒ³ã§ä¿®æ­£ç†ç”±ã‚’é¸æŠã—Claudeã«ã¾ã¨ã‚ã¦ä¿®æ­£ä¾é ¼ã§ãã‚‹ã€‚</div></div>
      <hr class="help-divider">
      <div style="font-size:0.75rem;color:#6b7280;">ğŸ’¡ <strong>ã‚¿ã‚°å‘½åè¦å‰‡ï¼š</strong>ç”»åƒè¨ºæ–­::å¹´::å·::ã‚¿ã‚¤ãƒˆãƒ«ã€€ã¾ãŸã¯ã€€claude::é ˜åŸŸ::ç–¾æ‚£ã‚«ãƒ†ã‚´ãƒª::ç–¾æ‚£å</div>
    </div>
  </div>

  <!-- JSONå…¥åŠ› -->
  <div class="section">
    <div class="section-title">â‘  JSONã‚’è²¼ã‚Šä»˜ã‘</div>
    <textarea id="jsonInput" placeholder="ClaudeãŒå‡ºåŠ›ã—ãŸJSONã‚’ã“ã“ã«è²¼ã‚Šä»˜ã‘ã¦ãã ã•ã„..."></textarea>
    <div class="json-example">ä¾‹: [{"front": "è³ªå•", "back": "ç­”ãˆ", "extra": "è£œè¶³", "tag": "ç”»åƒè¨ºæ–­::2023::07::ã‚¿ã‚¤ãƒˆãƒ«"}]</div>
    <button class="load-btn" onclick="loadJSON()">èª­ã¿è¾¼ã‚€</button>
  </div>

  <!-- ä¿®æ­£ä¾é ¼ã¾ã¨ã‚ -->
  <div class="review-summary" id="reviewSummary">
    <div class="review-summary-title">
      âœï¸ ä¿®æ­£ä¾é ¼ãƒªã‚¹ãƒˆ
      <span class="review-count-badge" id="reviewCountBadge">0</span>
    </div>
    <button class="copy-review-btn" id="copyReviewBtn" onclick="copyReviewRequest()">
      Claudeã¸ã®ä¿®æ­£ä¾é ¼ã‚’ã‚³ãƒ”ãƒ¼
    </button>
  </div>

  <!-- ã‚«ãƒ¼ãƒ‰é¸æŠ -->
  <div class="section" id="cardSection" style="display:none">
    <div class="section-title">â‘¡ é€ä¿¡ã™ã‚‹å•é¡Œã‚’é¸æŠ</div>

    <div class="deck-row">
      <label>ãƒ‡ãƒƒã‚­åï¼š</label>
      <select id="deckName">
        <option value="ç”»åƒè¨ºæ–­">ç”»åƒè¨ºæ–­</option>
      </select>
      <button class="fetch-deck-btn" onclick="fetchDecks()">â†» å–å¾—</button>
    </div>

    <div class="controls">
      <button class="ctrl-btn all" onclick="toggleAll(true)">å…¨é¸æŠ</button>
      <button class="ctrl-btn none" onclick="toggleAll(false)">å…¨è§£é™¤</button>
      <span class="count" id="countLabel">0 / 0 å•é¸æŠä¸­</span>
    </div>

    <div class="card-list" id="cardList"></div>

    <button class="send-btn" id="sendBtn" onclick="sendToAnki()">Ankiã«é€ä¿¡</button>
    <div id="statusMsg" style="display:none"></div>
  </div>
</div>

<script>
  let questions = [];
  let checked = {};
  let reviewReasons = {}; // { index: { reason, custom } }

  const REASON_OPTIONS = [
    "â”€â”€ å•é¡Œæ–‡ã®å•é¡Œ â”€â”€",
    "å•é¡Œæ–‡ãŒãƒ’ãƒ³ãƒˆã«ãªã£ã¦ã„ã‚‹",
    "å•é¡Œæ–‡ãŒé•·ã™ãã‚‹ãƒ»è¤‡é›‘ã™ãã‚‹",
    "å•é¡Œã®ç¯„å›²ãŒåºƒã™ãã‚‹",
    "å•ã„æ–¹ãŒæ›–æ˜§",
    "â”€â”€ ç­”ãˆã®å•é¡Œ â”€â”€",
    "ç­”ãˆãŒé•·ã™ãã‚‹",
    "ç­”ãˆã«å«ã‚ã‚‹æƒ…å ±ãŒå¤šã™ãã‚‹",
    "ç­”ãˆãŒçŸ­ã™ãã¦ä¸ååˆ†",
    "Extraã§ã¯ãªãBackã«å…¥ã‚Œã‚‹ã¹ãæƒ…å ±ãŒã‚ã‚‹",
    "â”€â”€ å†…å®¹ã®å•é¡Œ â”€â”€",
    "åŒ»å­¦çš„ã«ä¸æ­£ç¢º",
    "é‡è¦ãªãƒã‚¤ãƒ³ãƒˆãŒæŠœã‘ã¦ã„ã‚‹",
    "å•é¡Œè‡ªä½“ãŒé‡è¤‡ã—ã¦ã„ã‚‹",
    "â”€â”€ å½¢å¼ã®å•é¡Œ â”€â”€",
    "Q&Aå½¢å¼ã‚ˆã‚ŠClozeå½¢å¼ã«ã—ãŸã„",
    "å•é¡Œã‚’åˆ†å‰²ã—ãŸã„",
    "å•é¡Œã‚’çµ±åˆã—ãŸã„",
    "â”€â”€ ãã®ä»– â”€â”€",
    "ãã®ä»–ï¼ˆã‚«ã‚¹ã‚¿ãƒ ï¼‰"
  ];

  function loadJSON() {
    const raw = document.getElementById('jsonInput').value.trim();
    try {
      const data = JSON.parse(raw);
      if (!Array.isArray(data)) throw new Error('é…åˆ—å½¢å¼ã§å…¥åŠ›ã—ã¦ãã ã•ã„');
      questions = data;
      checked = {};
      reviewReasons = {};
      questions.forEach((_, i) => checked[i] = true);
      renderCards();
      document.getElementById('cardSection').style.display = 'block';
      document.getElementById('statusMsg').style.display = 'none';
      updateReviewSummary();
    } catch(e) {
      alert('JSONã®å½¢å¼ãŒæ­£ã—ãã‚ã‚Šã¾ã›ã‚“: ' + e.message);
    }
  }

  function renderCards() {
    const list = document.getElementById('cardList');
    if (questions.length === 0) {
      list.innerHTML = '<div class="empty">å•é¡ŒãŒã‚ã‚Šã¾ã›ã‚“</div>';
      updateCount();
      return;
    }

    list.innerHTML = questions.map((q, i) => {
      const isChecked = checked[i];
      const isReview = reviewReasons[i] !== undefined;
      const reasonData = reviewReasons[i] || {};

      const optionsHtml = REASON_OPTIONS.map(opt => {
        const isHeader = opt.startsWith('â”€â”€');
        if (isHeader) return `<option disabled>${opt}</option>`;
        return `<option value="${opt}" ${reasonData.reason === opt ? 'selected' : ''}>${opt}</option>`;
      }).join('');

      return `
        <div class="card-item ${isChecked ? 'checked' : ''} ${isReview ? 'review-marked' : ''}" id="card-${i}">
          <div class="card-row">
            <div class="checkbox" onclick="toggle(${i})">
              <svg class="checkmark" width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="3">
                <path d="M5 13l4 4L19 7"/>
              </svg>
            </div>
            <div class="card-content">
              <div class="card-meta">
                <span class="qnum">Q${i+1}</span>
                <span class="qtag">${q.tag || ''}</span>
              </div>
              <div class="qfront">${q.front}</div>
              <div class="qback">${q.back}</div>
              ${q.extra ? `<div class="qextra">${q.extra}</div>` : ''}
              <div class="card-actions">
                <button class="review-btn ${isReview ? 'active' : ''}" onclick="toggleReviewPanel(${i})">
                  âœï¸ ${isReview ? 'ä¿®æ­£ä¾é ¼ä¸­' : 'ä¿®æ­£ã‚’ä¾é ¼'}
                </button>
              </div>
              <div class="review-panel ${isReview ? 'open' : ''}" id="review-panel-${i}">
                <div class="review-panel-label">ä¿®æ­£ç†ç”±ã‚’é¸æŠ</div>
                <select id="reason-select-${i}" onchange="onReasonChange(${i})">
                  <option value="">é¸æŠã—ã¦ãã ã•ã„</option>
                  ${optionsHtml}
                </select>
                <input
                  type="text"
                  class="custom-input ${reasonData.reason === 'ãã®ä»–ï¼ˆã‚«ã‚¹ã‚¿ãƒ ï¼‰' ? 'show' : ''}"
                  id="reason-custom-${i}"
                  placeholder="ä¿®æ­£ç†ç”±ã‚’å…¥åŠ›..."
                  value="${reasonData.custom || ''}"
                  oninput="onCustomInput(${i})"
                >
              </div>
            </div>
          </div>
        </div>
      `;
    }).join('');
    updateCount();
  }

  function toggle(i) {
    checked[i] = !checked[i];
    renderCards();
  }

  function toggleAll(val) {
    questions.forEach((_, i) => checked[i] = val);
    renderCards();
  }

  function toggleReviewPanel(i) {
    const panel = document.getElementById(`review-panel-${i}`);
    if (reviewReasons[i] !== undefined) {
      // ä¿®æ­£ä¾é ¼è§£é™¤
      delete reviewReasons[i];
    } else {
      // ä¿®æ­£ä¾é ¼è¿½åŠ ï¼ˆç†ç”±æœªé¸æŠçŠ¶æ…‹ã§é–‹ãï¼‰
      reviewReasons[i] = { reason: '', custom: '' };
    }
    renderCards();
    updateReviewSummary();
  }

  function onReasonChange(i) {
    const val = document.getElementById(`reason-select-${i}`).value;
    const customInput = document.getElementById(`reason-custom-${i}`);
    if (val === 'ãã®ä»–ï¼ˆã‚«ã‚¹ã‚¿ãƒ ï¼‰') {
      customInput.classList.add('show');
    } else {
      customInput.classList.remove('show');
    }
    if (!reviewReasons[i]) reviewReasons[i] = {};
    reviewReasons[i].reason = val;
    reviewReasons[i].custom = '';
    updateReviewSummary();
  }

  function onCustomInput(i) {
    const val = document.getElementById(`reason-custom-${i}`).value;
    if (!reviewReasons[i]) reviewReasons[i] = {};
    reviewReasons[i].custom = val;
    updateReviewSummary();
  }

  function updateReviewSummary() {
    const keys = Object.keys(reviewReasons);
    const summary = document.getElementById('reviewSummary');
    const badge = document.getElementById('reviewCountBadge');
    if (keys.length > 0) {
      summary.classList.add('show');
      badge.textContent = keys.length;
    } else {
      summary.classList.remove('show');
    }
  }

  function copyReviewRequest() {
    const lines = ['ä»¥ä¸‹ã®å•é¡Œã®ä¿®æ­£ã‚’ãŠé¡˜ã„ã—ã¾ã™ï¼š\n'];
    Object.entries(reviewReasons).forEach(([i, data]) => {
      const q = questions[i];
      const reason = data.reason === 'ãã®ä»–ï¼ˆã‚«ã‚¹ã‚¿ãƒ ï¼‰'
        ? (data.custom || 'ç†ç”±æœªå…¥åŠ›')
        : (data.reason || 'ç†ç”±æœªé¸æŠ');
      lines.push(`ã€Q${parseInt(i)+1}ã€‘`);
      lines.push(`è¡¨é¢ï¼š${q.front}`);
      lines.push(`è£é¢ï¼š${q.back}`);
      lines.push(`ä¿®æ­£ç†ç”±ï¼š${reason}`);
      lines.push('');
    });

    navigator.clipboard.writeText(lines.join('\n')).then(() => {
      const btn = document.getElementById('copyReviewBtn');
      btn.textContent = 'âœ“ ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸï¼Claudeã«è²¼ã‚Šä»˜ã‘ã¦ãã ã•ã„';
      btn.classList.add('copied');
      setTimeout(() => {
        btn.textContent = 'Claudeã¸ã®ä¿®æ­£ä¾é ¼ã‚’ã‚³ãƒ”ãƒ¼';
        btn.classList.remove('copied');
      }, 3000);
    });
  }

  function updateCount() {
    const sel = Object.values(checked).filter(Boolean).length;
    document.getElementById('countLabel').textContent = `${sel} / ${questions.length} å•é¸æŠä¸­`;
    const btn = document.getElementById('sendBtn');
    btn.disabled = sel === 0;
    btn.textContent = sel === 0 ? 'å•é¡Œã‚’é¸æŠã—ã¦ãã ã•ã„' : `é¸æŠã—ãŸ ${sel} å•ã‚’Ankiã«é€ä¿¡`;
  }

  async function fetchDecks() {
    try {
      const decks = await ankiRequest('deckNames', {});
      const select = document.getElementById('deckName');
      const current = select.value;
      select.innerHTML = decks.sort().map(d =>
        `<option value="${d}" ${d === current ? 'selected' : ''}>${d}</option>`
      ).join('');
    } catch(e) {
      alert('Ankiã«æ¥ç¶šã§ãã¾ã›ã‚“ã§ã—ãŸã€‚AnkiãŒèµ·å‹•ã—ã¦ã„ã‚‹ã‹ç¢ºèªã—ã¦ãã ã•ã„ã€‚');
    }
  }

  async function ankiRequest(action, params) {
    const res = await fetch('http://127.0.0.1:8765', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ action, version: 6, params })
    });
    const data = await res.json();
    if (data.error) throw new Error(data.error);
    return data.result;
  }

  function showStatus(type, msg) {
    const el = document.getElementById('statusMsg');
    el.style.display = 'block';
    el.className = 'status ' + type;
    el.textContent = msg;
  }

  async function sendToAnki() {
    const selected = questions.filter((_, i) => checked[i]);
    if (selected.length === 0) return;
    const deckName = document.getElementById('deckName').value || 'ç”»åƒè¨ºæ–­';
    document.getElementById('sendBtn').disabled = true;
    showStatus('loading', 'é€ä¿¡ä¸­...');
    try {
      const decks = await ankiRequest('deckNames', {});
      if (!decks.includes(deckName)) {
        await ankiRequest('createDeck', { deck: deckName });
      }
      const notes = selected.map(q => ({
        deckName,
        modelName: 'Basic',
        fields: {
          Front: q.front,
          Back: `${q.back}${q.extra ? '<br><br><small style="color:#666">' + q.extra + '</small>' : ''}`,
        },
        tags: (q.tag || '').split(' '),
        options: { allowDuplicate: false, duplicateScope: 'deck' }
      }));
      const result = await ankiRequest('addNotes', { notes });
      const failed = result.filter(r => r === null).length;
      const succeeded = result.length - failed;
      if (failed > 0 && succeeded === 0) {
        showStatus('error', 'å…¨å•ãŒé‡è¤‡ã®ãŸã‚ã‚¹ã‚­ãƒƒãƒ—ã•ã‚Œã¾ã—ãŸã€‚');
      } else if (failed > 0) {
        showStatus('error', `${succeeded}å•ã‚’è¿½åŠ ã—ã¾ã—ãŸã€‚${failed}å•ã¯é‡è¤‡ã®ãŸã‚ã‚¹ã‚­ãƒƒãƒ—ã€‚`);
      } else {
        showStatus('success', `âœ“ ${succeeded}å•ã‚’ãƒ‡ãƒƒã‚­ã€Œ${deckName}ã€ã«é€ä¿¡ã—ã¾ã—ãŸï¼`);
      }
    } catch(e) {
      showStatus('error', 'Ankiã«æ¥ç¶šã§ãã¾ã›ã‚“ã§ã—ãŸã€‚AnkiãŒèµ·å‹•ã—ã¦ã„ã‚‹ã‹ç¢ºèªã—ã¦ãã ã•ã„ã€‚');
    } finally {
      updateCount();
    }
  }

  function toggleHelp() {
    const btn = document.getElementById('helpToggle');
    const body = document.getElementById('helpBody');
    btn.classList.toggle('open');
    body.classList.toggle('open');
  }
</script>
</body>
</html>
